@startuml
!theme plain
skinparam stateBorderColor #2E7D32
skinparam stateBackgroundColor #E8F5E9

title ProductionBatch State Machine Diagram

[*] --> Created : Factory initiates\nnew batch

state Created {
  Created : batch_id assigned
  Created : product type set
  Created : quantity_units = 50
  Created : created_at timestamp
}

Created --> SlipPrepQueued : enters slip\nbuffer queue

state SlipPrepQueued {
  SlipPrepQueued : waiting for slip prep line
}

SlipPrepQueued --> SlipPrepInProgress : machine available

state SlipPrepInProgress {
  SlipPrepInProgress : mixing raw materials
  SlipPrepInProgress : ball milling
  SlipPrepInProgress : adding water for slip
}

SlipPrepInProgress --> CastingQueued : slip prep complete\nset casting_done timestamp

state CastingQueued {
  CastingQueued : in slip_buffer
  CastingQueued : waiting for casting station
}

CastingQueued --> CastingInProgress : station available

state CastingInProgress {
  CastingInProgress : pouring slip into gypsum molds
  CastingInProgress : water absorption
  CastingInProgress : duration: ~6 hours
}

CastingInProgress --> DemoldingQueued : casting complete\nset casting_done timestamp

state DemoldingQueued {
  DemoldingQueued : in cast_store
  DemoldingQueued : waiting for demolding
}

DemoldingQueued --> DemoldingInProgress : station available

state DemoldingInProgress {
  DemoldingInProgress : extracting from molds
  DemoldingInProgress : air drying
  DemoldingInProgress : duration: ~18 hours
}

DemoldingInProgress --> FettlingQueued : set demolded_at\ntimestamp

state FettlingQueued {
  FettlingQueued : in demolded_store
  FettlingQueued : waiting for fettling
}

FettlingQueued --> FettlingInProgress : station available

state FettlingInProgress {
  FettlingInProgress : removing mold seams
  FettlingInProgress : creating water passages
  FettlingInProgress : surface smoothing
}

FettlingInProgress --> GlazingQueued : set fettled_at\ntimestamp

state GlazingQueued {
  GlazingQueued : in fettled_store
  GlazingQueued : waiting for glazing line
}

GlazingQueued --> GlazingInProgress : line available

state GlazingInProgress {
  GlazingInProgress : applying white glaze
  GlazingInProgress : coverage inspection
}

GlazingInProgress --> FiringQueued : set glazing_done\ntimestamp

state FiringQueued {
  FiringQueued : in glazed_store
  FiringQueued : waiting for tunnel kiln
  FiringQueued : [SEVERE BOTTLENECK!!]
}

FiringQueued --> FiringInProgress : kiln available

state FiringInProgress {
  FiringInProgress : firing at 1200-1250°C
  FiringInProgress : duration: ~24 HOURS!!
  FiringInProgress : [CRITICAL STAGE]
}

FiringInProgress --> FinishingQueued : set firing_done\ntimestamp

state FinishingQueued {
  FinishingQueued : in fired_store
  FinishingQueued : waiting for finishing line
}

FinishingQueued --> FunctionalTesting : line available

state FunctionalTesting {
  FunctionalTesting : visual inspection
  FunctionalTesting : leak test (98% pass rate)
  FunctionalTesting : flush test (97% pass rate)
}

FunctionalTesting --> Completed : set leak_test_pass,\nflush_test_pass\nset finished_at timestamp

state Completed {
  Completed : cycle_time_hr calculated
  Completed : saleable_units counted
  Completed : added to FG inventory
  Completed : metrics recorded
}

Completed --> [*]

note right of FiringQueued
  Tunnel kiln is THE SEVERE bottleneck.
  Batches queue longest here.
  Only 1 kiln × 24h = 1 batch/day max!
  This is 6× slower than tile kilns.
end note

note right of Completed
  Typical cycle time: 40-60 hours
  depending on queuing delays and
  the 24h tunnel kiln cycle.
end note

@enduml
