@startuml
!theme plain
skinparam sequenceMessageAlign center
skinparam maxMessageSize 150

title Production Batch Processing Sequence Diagram

actor "SimPy\nEnvironment" as Env
participant "Factory" as Factory
participant "ProductionBatch" as Batch
participant "SlipPrepLine" as SlipPrep
participant "CastingStation" as Casting
participant "DemoldingStation" as Demolding
participant "FettlingStation" as Fettling
participant "GlazingLine" as Glazing
participant "TunnelKiln" as Kiln
participant "FinishingLine" as Finishing
participant "MetricsCollector" as Metrics
participant "FG Inventory" as FG

Env -> Factory: trigger slip_preparation()
activate Factory

Factory -> Batch: create(batch_id, product, 50 units)
activate Batch
Batch --> Factory: batch object

Factory -> Factory: consume raw materials\n(clay, feldspar, silica, kaolin)

Factory -> SlipPrep: request()
activate SlipPrep
SlipPrep --> Factory: granted

Factory -> Factory: process for 3.5h\n(mixing, milling, add water)

Factory -> Batch: set casting_done timestamp
Factory -> SlipPrep: release()
deactivate SlipPrep

Factory -> Factory: put batch in slip_buffer

Factory -> Casting: request()
activate Casting
Casting --> Factory: granted

Factory -> Factory: pour slip into molds\nfor 6 hours

Factory -> Batch: set casting_done timestamp
Factory -> Casting: release()
deactivate Casting

Factory -> Factory: put batch in cast_store

Factory -> Demolding: request()
activate Demolding
Demolding --> Factory: granted

Factory -> Factory: extract from molds\nair dry for 18 hours

Factory -> Batch: set demolded_at timestamp
Factory -> Demolding: release()
deactivate Demolding

Factory -> Factory: put batch in demolded_store

Factory -> Fettling: request()
activate Fettling
Fettling --> Factory: granted

Factory -> Factory: remove seams,\ncreate passages (2.5h)

Factory -> Batch: set fettled_at timestamp
Factory -> Fettling: release()
deactivate Fettling

Factory -> Factory: put batch in fettled_store

Factory -> Glazing: request()
activate Glazing
Glazing --> Factory: granted

Factory -> Factory: apply white glaze for 0.4h
Factory -> Batch: set glazing_done timestamp
Factory -> Glazing: release()
deactivate Glazing

Factory -> Factory: put batch in glazed_store

Factory -> Kiln: request()
activate Kiln
note right: Tunnel Kiln is SEVERE bottleneck\n(24h per batch, only 1 kiln!)
Kiln --> Factory: granted

Factory -> Factory: fire at 1200-1250Â°C\nfor 24 hours!!

Factory -> Batch: set firing_done timestamp
Factory -> Kiln: release()
deactivate Kiln

Factory -> Factory: put batch in fired_store

Factory -> Finishing: request()
activate Finishing
Finishing --> Factory: granted

Factory -> Factory: visual inspect,\nfunctional testing (1.2h)

Factory -> Batch: leak_test_pass = 98% probability
Factory -> Batch: flush_test_pass = 97% probability

Factory -> Batch: set finished_at timestamp
Batch -> Batch: calculate cycle_time_hr

Factory -> Finishing: release()
deactivate Finishing

Factory -> FG: add saleable_units to inventory[product]
activate FG
FG --> Factory: updated level

Factory -> Metrics: record_batch(batch)
activate Metrics
Metrics -> Metrics: store in completed_batches[]
Metrics --> Factory: logged

deactivate Factory
deactivate Batch
deactivate FG
deactivate Metrics

@enduml
